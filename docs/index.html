<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeepChief</title>
    <style>
      :root { --dc-bg:#0b1321; --dc-panel:#121b2e; --dc-text:#e6edf6; --dc-accent:#57a6ff; --dc-good:#2ecc71; --dc-warn:#f39c12; --dc-bad:#e74c3c; --dc-muted:#8b99b5; }
      html,body { margin:0; padding:0; background:var(--dc-bg); color:var(--dc-text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      header { padding:16px; border-bottom:1px solid var(--dc-panel); display:flex; align-items:center; gap:12px; position:sticky; top:0; background:var(--dc-bg); z-index:2; }
      h1,h2 { margin:0 0 8px 0; letter-spacing:.5px; }
      .layout { max-width:1200px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns: 220px 1fr; gap:16px; }
      nav.sidenav { position:sticky; top:64px; align-self:start; }
      nav.sidenav a { display:block; padding:8px 10px; margin:4px 0; color:var(--dc-text); text-decoration:none; border-radius:6px; font-size:14px; }
      nav.sidenav a:hover { background:rgba(255,255,255,0.06); }
      nav.sidenav a.active { background:rgba(255,255,255,0.06); }
      main { min-width:0; }
      section { background:var(--dc-panel); padding:16px; border-radius:8px; margin-bottom:16px; }
      .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(180px,1fr)); gap:12px; }
      .kpi-card { background:#0f1830; border:1px solid #1a2a4a; border-radius:8px; padding:10px; display:grid; gap:6px; }
      .kpi-title { font-size:12px; color:var(--dc-muted); }
      .kpi-value { font-size:18px; font-weight:600; }
      .delta { font-size:12px; border-radius:999px; padding:2px 8px; display:inline-block; }
      .delta.good { background: rgba(46, 204, 113, .15); color:var(--dc-good); }
      .delta.bad { background: rgba(231, 76, 60, .15); color:var(--dc-bad); }
      .chips { display:flex; gap:6px; flex-wrap:wrap; }
      .chip { border-radius:999px; padding:2px 8px; font-size:12px; }
      .chip.ok { background: rgba(46, 204, 113, .15); color:var(--dc-good); }
      .chip.warn { background: rgba(243, 156, 18, .15); color:var(--dc-warn); }
      .chip.err { background: rgba(231, 76, 60, .15); color:var(--dc-bad); }
      .tabs { display:flex; gap:8px; border-bottom:1px solid #1a2a4a; margin-bottom:8px; position:sticky; top:64px; background:var(--dc-panel); z-index:1; padding-bottom:8px; }
      .tab { padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
      .tab.active { background:#0f1830; border:1px solid #1a2a4a; }
      .tab-panel { display:none; }
      .tab-panel.active { display:block; }
      table { width:100%; border-collapse:collapse; }
      thead th { position:sticky; top:0; background:#0f1830; z-index:1; }
      th, td { padding:6px 4px; }
      th[align="right"], td[style*="text-align: right"] { text-align:right; }
      a { color: var(--dc-accent); text-decoration: none; }
      .drawer { position:fixed; top:0; right:0; width:420px; max-width:90vw; height:100vh; background:#0f1830; border-left:1px solid #1a2a4a; box-shadow: -12px 0 24px rgba(0,0,0,.3); transform: translateX(100%); transition: transform .25s ease; z-index:3; display:flex; flex-direction:column; }
      .drawer.open { transform: translateX(0); }
      .drawer header { position:sticky; top:0; background:#0f1830; border-bottom:1px solid #1a2a4a; }
      .drawer pre { white-space:pre-wrap; margin:0; padding:12px 16px; }
      .toolbar { position:sticky; top:64px; background:var(--dc-panel); padding:8px; border-radius:8px; border:1px solid #1a2a4a; display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
      .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.12), rgba(255,255,255,0.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; border-radius:6px; }
      @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
      @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } nav.sidenav { display:none; } .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
  </head>
  <body>
    <header>
      <h1>Console</h1>
    </header>
    <div class="layout">
      <nav class="sidenav">
        <a href="#close-to-cash">Close-to-Cash</a>
        <a href="#controls">Controls</a>
        <a href="#spend">Spend</a>
        <a href="#audit">Audit</a>
        <a href="#architecture">Architecture</a>
      </nav>
      <main>
        <section id="close-to-cash">
          <h2>Close-to-Cash</h2>
          <div class="kpi-grid" id="kpiGrid"></div>
          <div style="margin-top:12px">
            <svg id="cashChart" width="100%" height="140"></svg>
          </div>
        </section>
        <section id="why">
          <h2>Why</h2>
          <div class="chips" id="whyChips"></div>
          <div style="margin-top:8px">
            <button id="whyExpand">Expand</button>
          </div>
          <pre id="whyJson" style="white-space:pre-wrap; display:none"></pre>
        </section>
        <section id="hub">
          <div class="toolbar">
            <button disabled>Run Ingest</button>
            <button disabled>Run Reconciler</button>
            <button disabled>Run Controls</button>
            <button disabled>Run Flux</button>
            <button disabled>Run Forecast</button>
            <button disabled>Run DQ</button>
            <span id="lastRun" style="color:var(--dc-muted)"></span>
          </div>
          <div class="tabs" id="tabBar"></div>
          <div class="tab-panel" id="panel-gl">
            <h2>GL</h2>
            <table><thead><tr><th align="left">ID</th><th align="left">Entity</th><th align="left">Account</th><th align="right">Amount</th><th align="left">Date</th></tr></thead><tbody id="glBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-bank">
            <h2>Bank</h2>
            <table><thead><tr><th align="left">ID</th><th align="left">Account</th><th align="right">Amount</th><th align="left">Date</th></tr></thead><tbody id="bankBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-matches">
            <h2>Matches</h2>
            <table><thead><tr><th align="left">GL Entry</th><th align="left">Bank Txn</th><th align="right">Confidence</th><th align="left">Receipt</th></tr></thead><tbody id="matchBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-controls">
            <h2>Controls</h2>
            <table><thead><tr><th align="left">Control</th><th align="left">Window</th><th align="left">Findings</th><th align="left">Receipt</th></tr></thead><tbody id="ctrlBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-flux">
            <h2>Flux</h2>
            <table><thead><tr><th align="left">Entity</th><th align="left">Account</th><th align="left">Period</th><th align="left">Drivers</th><th align="left">Receipt</th></tr></thead><tbody id="fluxBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-forecast">
            <h2>Forecast</h2>
            <table><thead><tr><th align="left">Period</th><th align="left">Params</th><th align="left">Outputs</th><th align="left">Receipt</th></tr></thead><tbody id="fcBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-exceptions">
            <h2>Exceptions</h2>
            <table><thead><tr><th align="left">ID</th><th align="left">Type</th><th align="left">Status</th><th align="left">Assignee</th><th align="left">Receipt</th></tr></thead><tbody id="excBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-spend">
            <h2>Spend</h2>
            <table><thead><tr><th align="left">Type</th><th align="left">Vendor</th><th align="right">Amount</th><th align="left">Receipt</th></tr></thead><tbody id="spendBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-policies">
            <h2>Policies</h2>
            <table><thead><tr><th align="left">Key</th><th align="left">Active</th><th align="left">Checksum</th></tr></thead><tbody id="polBody"></tbody></table>
          </div>
          <div class="tab-panel" id="panel-invoices" style="display:none"></div>
          <div class="tab-panel" id="panel-employees" style="display:none"></div>
        </section>
        <section id="audit">
          <h2>Audit</h2>
          <div id="auditContent"></div>
        </section>
        <section id="architecture">
          <h2>Architecture</h2>
          <div style="display:grid; gap:12px">
            <img src="../dc-150.png" alt="DeepChief Architecture" style="max-width:100%; border:1px solid #1a2a4a; border-radius:8px" />
            <div class="chips">
              <span class="chip ok">Governance Spine</span>
              <span class="chip ok">Close-to-Cash</span>
              <span class="chip ok">Spend-to-Value</span>
            </div>
          </div>
        </section>
      </main>
    </div>
    <aside id="receiptDrawer" class="drawer" aria-hidden="true">
      <header>
        <div style="display:flex; align-items:center; justify-content:space-between; width:100%">
          <h2 style="margin:0">Receipt</h2>
          <button id="drawerClose" style="margin-left:auto">Close</button>
        </div>
      </header>
      <pre id="receiptJson" class="skeleton" style="height:100%;"></pre>
    </aside>
    <script>
      function percent(n){ return typeof n==='number'? `${n.toFixed(1)}%`:'-'}
      function fmt(n){ return n!=null? Number(n).toFixed(2): '-' }
      function mkChip(text, cls){ const s=document.createElement('span'); s.className=`chip ${cls}`; s.textContent=text; return s }
      function sparklinePath(values, w, h, pad=4){ if(!values||!values.length) return ''; const min=Math.min(...values), max=Math.max(...values); const r=max-min||1; const sx=(w-pad*2)/(values.length-1||1); const pts=values.map((v,i)=>{ const x=pad+i*sx; const y=h-pad-((v-min)/r)*(h-pad*2); return [x,y] }); return 'M '+pts.map(p=>p.join(',')).join(' L ') }
      function areaPath(values, w, h, pad=4){ if(!values||!values.length) return ''; const min=Math.min(...values), max=Math.max(...values); const r=max-min||1; const sx=(w-pad*2)/(values.length-1||1); const top=values.map((v,i)=>{ const x=pad+i*sx; const y=h-pad-((v-min)/r)*(h-pad*2); return [x,y] }); const bottom=[[w-pad,h-pad],[pad,h-pad]]; return 'M '+top.map(p=>p.join(',')).join(' L ')+' L '+bottom.map(p=>p.join(',')).join(' L ')+' Z' }
      function makeTabBar(tabs){ const bar=document.getElementById('tabBar'); tabs.forEach((t,i)=>{ const b=document.createElement('div'); b.className='tab'+(i===0?' active':''); b.textContent=t.label; b.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active')); b.classList.add('active'); document.getElementById(t.panelId).classList.add('active'); }; bar.appendChild(b); }); document.getElementById(tabs[0].panelId).classList.add('active') }
      function openReceipt(id){ const el=document.getElementById('receiptDrawer'); const pre=document.getElementById('receiptJson'); pre.textContent=''; pre.classList.add('skeleton'); el.classList.add('open'); fetch(`./receipts/${id}.json`).then(r=>r.ok?r.json():Promise.reject()).then(j=>{ pre.classList.remove('skeleton'); pre.textContent=JSON.stringify(j,null,2) }).catch(()=>{ pre.classList.remove('skeleton'); pre.textContent=`{"id":"${id}","verify":"signed","note":"payload not available"}` }) }
      document.getElementById('drawerClose').onclick=()=>{ document.getElementById('receiptDrawer').classList.remove('open') }

      const TAB_MAP = {
        GL: 'panel-gl',
        Bank: 'panel-bank',
        Matches: 'panel-matches',
        Controls: 'panel-controls',
        Flux: 'panel-flux',
        Forecast: 'panel-forecast',
        Exceptions: 'panel-exceptions',
        Spend: 'panel-spend',
        Policies: 'panel-policies',
      };

      function setActivePanel(panelId){
        document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
        const el = document.getElementById(panelId);
        if (el) el.classList.add('active');
        const bar = document.getElementById('tabBar');
        if (bar){
          Array.from(bar.children).forEach((t)=>{
            const label = t.textContent || '';
            if (TAB_MAP[label] === panelId) t.classList.add('active'); else t.classList.remove('active');
          });
        }
      }

      function showScreens(key){
        const showIds = new Set();
        const hideIds = ['close-to-cash','why','hub','audit','architecture'];
        const toolbar = document.querySelector('.toolbar');
        const tabBar = document.getElementById('tabBar');
        if (key === 'controls'){ showIds.add('hub'); setActivePanel('panel-controls'); }
        else if (key === 'spend'){ showIds.add('hub'); setActivePanel('panel-spend'); }
        else if (key === 'audit'){ showIds.add('audit'); }
        else if (key === 'architecture'){ showIds.add('architecture'); }
        else { // close/default
          showIds.add('close-to-cash'); showIds.add('why'); showIds.add('hub'); setActivePanel('panel-gl');
        }
        hideIds.forEach(id=>{
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = showIds.has(id) ? '' : 'none';
        });
        if (toolbar) toolbar.style.display = (key==='close') ? '' : 'none';
        if (tabBar) tabBar.style.display = (key==='close') ? '' : 'none';
        // highlight nav link
        document.querySelectorAll('nav.sidenav a').forEach(a=>{
          const h = (a.getAttribute('href')||'').replace('#','');
          const isClose = (key==='close' && (h==='close-to-cash'));
          a.classList.toggle('active', h===key || isClose);
        });
        window.scrollTo(0,0);
      }

      function route(){
        const raw = (location.hash || '').toLowerCase();
        if (raw.includes('controls')) return showScreens('controls');
        if (raw.includes('spend')) return showScreens('spend');
        if (raw.includes('audit')) return showScreens('audit');
        if (raw.includes('architecture')) return showScreens('architecture');
        return showScreens('close');
      }

      async function safeLoad(path){
        try { const r = await fetch(path); if (!r.ok) return null; return await r.json(); } catch { return null }
      }

      async function load() {
        const j = await fetch('./demo_state.json').then(r=>r.json());
        let k = j.kpi || {};
        try { const k2 = await fetch('./mock-data/kpis.json').then(r=>r.json()); if (k2 && k2.close_to_cash) k = { ...k, ...k2.close_to_cash } } catch {}
        const kpiGrid = document.getElementById('kpiGrid');
        const cards = [
          { title:'Auto Match Rate', value: percent(k.auto_match_rate ?? j.kpi?.auto_match_rate), trend:[50,55,60,58,62,65,66,67,68,70,72,75] },
          { title:'Controls Pass', value: percent(k.controls_pass_rate ?? j.kpi?.controls_pass_rate), trend:[80,81,82,83,84,85,86,84,85,86,87,88] },
          { title:'Exceptions Open', value: (k.exceptions_open ?? j.kpi?.exceptions_open ?? '-'), trend:[40,38,36,35,34,33,32,31,30,29,28,27] },
          { title:'Flux Ready', value: percent(k.flux_ready_percent ?? j.kpi?.flux_ready_percent), trend:[40,45,48,52,55,57,60,62,64,66,68,70] },
          { title:'GL Count', value: (k.gl_count ?? j.kpi?.gl_count ?? '-'), trend:[10,12,11,13,12,14,16,15,17,18,19,20] },
          { title:'Bank Count', value: (k.bank_count ?? j.kpi?.bank_count ?? '-'), trend:[9,10,10,11,11,12,12,13,13,14,14,15] },
          { title:'Matched', value: (k.matched_count ?? j.kpi?.matched_count ?? '-'), trend:[6,7,7,8,8,9,10,10,11,12,13,14] },
          { title:'MTTR (days)', value: (k.exceptions_mttr_days ?? j.kpi?.exceptions_mttr_days ?? '-'), trend:[5,4.8,4.6,4.4,4.2,4.0,3.8,3.6,3.4,3.3,3.2,3.2] },
        ];
        const width = 160, height=36;
        cards.forEach((c)=>{
          const card=document.createElement('div'); card.className='kpi-card';
          const t=document.createElement('div'); t.className='kpi-title'; t.textContent=c.title; card.appendChild(t);
          const v=document.createElement('div'); v.className='kpi-value'; v.textContent=c.value; card.appendChild(v);
          const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('width', String(width)); svg.setAttribute('height', String(height));
          const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d', sparklinePath(c.trend, width, height)); path.setAttribute('fill','none'); path.setAttribute('stroke', 'url(#grad)'); path.setAttribute('stroke-width','2');
          const defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); const lg=document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); lg.setAttribute('id','grad'); lg.setAttribute('x1','0'); lg.setAttribute('x2','1'); lg.setAttribute('y1','0'); lg.setAttribute('y2','0'); const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color', '#57a6ff'); const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color', '#2ecc71'); lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg);
          svg.appendChild(defs); svg.appendChild(path); card.appendChild(svg);
          kpiGrid.appendChild(card);
        });

        // Treasury cash area chart
        let cash = [];
        try { const t = await fetch('./mock-data/treasury_cash.json').then(r=>r.json()); cash = (t.series||[]).map(x=>x.balance) } catch {}
        const svg = document.getElementById('cashChart'); const BB=svg.getBoundingClientRect(); const W=BB.width||800, H=140; svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
        const ap = areaPath(cash.length? cash : [152000,150200,149400,150900,149100,151000,150500,148800,149300,150100,151400,150700,152200,153000], W, H);
        const aPath=document.createElementNS('http://www.w3.org/2000/svg','path'); aPath.setAttribute('d', ap); aPath.setAttribute('fill','rgba(87,166,255,.15)'); aPath.setAttribute('stroke','#57a6ff'); aPath.setAttribute('stroke-width','2'); svg.appendChild(aPath);

        // Controls donut
        try {
          const donut = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          donut.setAttribute('width','160'); donut.setAttribute('height','120'); donut.setAttribute('viewBox','0 0 120 120');
          const pctNum = typeof k.controls_pass_rate === 'number' ? k.controls_pass_rate : (j.kpi?.controls_pass_rate || 0);
          const pct = Math.max(0, Math.min(100, pctNum));
          const cx=60, cy=60, r=36, c=2*Math.PI*r, dash=(pct/100)*c;
          const bg=document.createElementNS('http://www.w3.org/2000/svg','circle'); bg.setAttribute('cx',cx); bg.setAttribute('cy',cy); bg.setAttribute('r',r); bg.setAttribute('fill','none'); bg.setAttribute('stroke','#1a2a4a'); bg.setAttribute('stroke-width','10');
          const fg=document.createElementNS('http://www.w3.org/2000/svg','circle'); fg.setAttribute('cx',cx); fg.setAttribute('cy',cy); fg.setAttribute('r',r); fg.setAttribute('fill','none'); fg.setAttribute('stroke','#2ecc71'); fg.setAttribute('stroke-width','10'); fg.setAttribute('stroke-dasharray', `${dash} ${c-dash}`); fg.setAttribute('transform',`rotate(-90 ${cx} ${cy})`);
          const txt=document.createElementNS('http://www.w3.org/2000/svg','text'); txt.setAttribute('x', String(cx)); txt.setAttribute('y', String(cy+5)); txt.setAttribute('text-anchor','middle'); txt.setAttribute('fill','#e6edf6'); txt.textContent = `${pct.toFixed(1)}%`;
          const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `Controls pass rate: ${pct.toFixed(1)}%`;
          document.getElementById('panel-controls').appendChild(donut); donut.appendChild(bg); donut.appendChild(fg); donut.appendChild(txt); donut.appendChild(tl);
        } catch {}

        // Forecast cone vs actuals
        try {
          const panelFc = document.getElementById('panel-forecast');
          const W = 320, H = 140, pad = 16;
          const svgFc = document.createElementNS('http://www.w3.org/2000/svg','svg'); svgFc.setAttribute('width', String(W)); svgFc.setAttribute('height', String(H)); svgFc.setAttribute('viewBox', `0 0 ${W} ${H}`);
          // Build a small synthetic cone using last cash value as base
          let base = 150000;
          try { if (Array.isArray(cash) && cash.length) base = Number(cash[cash.length-1]) || base } catch {}
          const steps = 10;
          const p50 = Array.from({length: steps}, (_, i) => base + i*800);
          const p75 = p50.map((v, i) => v + i*250);
          const p90 = p50.map((v, i) => v + i*450);
          const minV = Math.min(base, ...p50);
          const maxV = Math.max(...p90);
          const scaleY = (val) => {
            const r = maxV - minV || 1; return H - pad - ((val - minV)/r)*(H - pad*2);
          }
          const scaleX = (i) => pad + (i/(steps-1))*(W - pad*2);
          const pathArea = (upper, lower) => {
            const up = upper.map((v,i)=>`${scaleX(i)},${scaleY(v)}`).join(' L ');
            const lo = lower.slice().reverse().map((v,i)=>`${scaleX(steps-1-i)},${scaleY(v)}`).join(' L ');
            return `M ${up} L ${lo} Z`;
          }
          const a90 = document.createElementNS('http://www.w3.org/2000/svg','path'); a90.setAttribute('d', pathArea(p90, p50)); a90.setAttribute('fill','rgba(87,166,255,.15)');
          const a75 = document.createElementNS('http://www.w3.org/2000/svg','path'); a75.setAttribute('d', pathArea(p75, p50)); a75.setAttribute('fill','rgba(46,204,113,.18)');
          const l50 = document.createElementNS('http://www.w3.org/2000/svg','path'); l50.setAttribute('d', `M ${p50.map((v,i)=>`${scaleX(i)},${scaleY(v)}`).join(' L ')}`); l50.setAttribute('fill','none'); l50.setAttribute('stroke','#57a6ff'); l50.setAttribute('stroke-width','2');
          svgFc.appendChild(a90); svgFc.appendChild(a75); svgFc.appendChild(l50);
          const title = document.createElement('h3'); title.style.margin='8px 0 6px 0'; title.style.fontSize='14px'; title.style.color='var(--dc-muted)'; title.textContent='Forecast Cone (P50/P75/P90)';
          const wrapFc = document.createElement('div'); wrapFc.appendChild(title); wrapFc.appendChild(svgFc);
          panelFc.appendChild(wrapFc);
        } catch {}

        // Exceptions histogram
        try {
          const ex = Array.isArray(j.exceptions) ? j.exceptions : [];
          const counts = {};
          ex.forEach(e => { const t = String(e.type||'other'); counts[t] = (counts[t]||0)+1 });
          const types = Object.keys(counts).slice(0,6);
          const maxV = Math.max(1, ...types.map(t=>counts[t]));
          const svgH = 120, svgW = 260, pad=20, bw = Math.max(12, (svgW - pad*2)/(types.length||1) - 8);
          const hist=document.createElementNS('http://www.w3.org/2000/svg','svg'); hist.setAttribute('width','260'); hist.setAttribute('height','120'); hist.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
          types.forEach((t,i)=>{
            const v = counts[t];
            const h = ((v/maxV) * (svgH - pad*2));
            const x = pad + i*(bw+8);
            const y = svgH - pad - h;
            const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',bw); rect.setAttribute('height',h); rect.setAttribute('fill','#57a6ff');
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${t}: ${v}`; rect.appendChild(tl);
            const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x', String(x + bw/2)); label.setAttribute('y', String(svgH - 4)); label.setAttribute('text-anchor','middle'); label.setAttribute('fill','#8b99b5'); label.setAttribute('font-size','10'); label.textContent = t;
            hist.appendChild(rect); hist.appendChild(label);
          })
          document.getElementById('panel-exceptions').appendChild(hist)
        } catch {}

        // Flux waterfall
        try {
          const fx = Array.isArray(j.flux) && j.flux[0] ? j.flux[0] : null;
          const drivers = fx?.drivers || { volume: 0.6, price: 0.3, fx: 0.1 };
          const vals = Object.entries(drivers).map(([k,v])=>({ key:k, value:Number(v) }));
          const svgW=260, svgH=120, pad=12, barH=12, gap=10; let x=pad, y=svgH/2;
          const wf=document.createElementNS('http://www.w3.org/2000/svg','svg'); wf.setAttribute('width','260'); wf.setAttribute('height','120'); wf.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);
          vals.forEach(d=>{
            const w = Math.max(10, Math.abs(d.value)* (svgW - pad*2 - 40));
            const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x', x); rect.setAttribute('y', String(y - barH/2)); rect.setAttribute('width', String(w)); rect.setAttribute('height', String(barH)); rect.setAttribute('fill', d.value>=0 ? '#2ecc71' : '#e74c3c');
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${d.key}: ${(d.value*100).toFixed(1)}%`; rect.appendChild(tl);
            const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x', String(x + w + 4)); label.setAttribute('y', String(y + 4)); label.setAttribute('fill','#e6edf6'); label.setAttribute('font-size','11'); label.textContent = d.key;
            wf.appendChild(rect); wf.appendChild(label);
            y += barH + gap;
          })
          document.getElementById('panel-flux').appendChild(wf)
        } catch {}

        // Why chips + drawer
        const why = j.whyCard || { kpi_snapshot: k };
        const chips = document.getElementById('whyChips');
        if (why.policy) chips.appendChild(mkChip(why.policy, 'ok'));
        if (why.result?.flag) chips.appendChild(mkChip(why.result.flag, 'warn'));
        if (why.receipt?.id) { const a=document.createElement('a'); a.href='#'; a.textContent=why.receipt.id; a.onclick=(e)=>{ e.preventDefault(); openReceipt(why.receipt.id) }; chips.appendChild(a) }
        const whyJson = document.getElementById('whyJson'); whyJson.textContent = JSON.stringify(why, null, 2);
        document.getElementById('whyExpand').onclick = ()=>{ const visible = whyJson.style.display !== 'none'; whyJson.style.display = visible ? 'none' : 'block' }

        // Tabs
        makeTabBar([
          { label:'GL', panelId:'panel-gl' },
          { label:'Bank', panelId:'panel-bank' },
          { label:'Matches', panelId:'panel-matches' },
          { label:'Controls', panelId:'panel-controls' },
          { label:'Flux', panelId:'panel-flux' },
          { label:'Forecast', panelId:'panel-forecast' },
          { label:'Exceptions', panelId:'panel-exceptions' },
          { label:'Spend', panelId:'panel-spend' },
          { label:'Policies', panelId:'panel-policies' },
        ]);

        // Helpers
        const put = (id, rows, render) => { const tb=document.getElementById(id); rows.forEach((r,i)=>tb.appendChild(render(r,i))); }
        const tr = (...cells)=>{ const tr=document.createElement('tr'); cells.forEach(c=>{ const td=document.createElement('td'); if (c && c.href){ const a=document.createElement('a'); a.href=c.href; a.textContent=c.text; a.onclick=(e)=>{ e.preventDefault(); openReceipt(c.text) }; td.appendChild(a);} else if (c instanceof HTMLElement) { td.appendChild(c) } else { td.textContent = c??'-'; } tr.appendChild(td); }); return tr; }

        // Try to enrich from docs/mock-data/* if available
        const gl2 = await safeLoad('./mock-data/gl_entries.json');
        const bank2 = await safeLoad('./mock-data/bank_txns.json');
        const m2 = await safeLoad('./mock-data/reconcile_matches.json');
        const ctrl2 = await safeLoad('./mock-data/control_runs.json');
        const flux2 = await safeLoad('./mock-data/flux_expl.json');
        const fc2 = await safeLoad('./mock-data/forecast_snapshots.json');
        const exc2 = await safeLoad('./mock-data/exceptions.json');
        const sp2 = await safeLoad('./mock-data/spend_issues.json');
        const pol2 = await safeLoad('./mock-data/policies.json');

        const GL = Array.isArray(gl2) && gl2.length ? gl2.map(r=>({ id:r.id, entity_id:r.entity_id, account:r.account, amount:r.amount, date:r.date })) : (j.gl||[]);
        const BANK = Array.isArray(bank2) && bank2.length ? bank2.map(r=>({ id:r.id, account_ref:r.account_ref||r.bank_account_ref, amount:r.amount, date:r.date||r.value_date })) : (j.bank||[]);
        const MATCH = Array.isArray(m2) && m2.length ? m2.map(r=>({ gl_entry_id:r.gl_entry_id, bank_txn_id:r.bank_txn_id, confidence: r.confidence ?? 1.0, receipt_id:r.receipt_id })) : (j.matches||[]);
        const CTRL = Array.isArray(ctrl2) && ctrl2.length ? ctrl2.map(r=>({ control_key:r.control_key, window_start:r.window_start, window_end:r.window_end, findings:r.findings, receipt_id:r.receipt_id })) : (j.controls||[]);
        const FLUX = Array.isArray(flux2) && flux2.length ? flux2.map(r=>({ entity_id:r.entity_id, account:r.account, period:r.period, drivers:r.drivers, receipt_id:r.receipt_id })) : (j.flux||[]);
        const FC = Array.isArray(fc2) && fc2.length ? fc2.map(r=>({ period:r.period, params:r.params, outputs:r.outputs, receipt_id:r.receipt_id })) : (j.forecast||[]);
        const EXC = Array.isArray(exc2) && exc2.length ? exc2.map(r=>({ id:r.id, entity_id:r.entity_id, type:r.type, status:r.status, assignee:r.assignee, receipt_id:r.receipt_id })) : (j.exceptions||[]);
        const SPEND = Array.isArray(sp2) && sp2.length ? sp2.map(r=>({ type:r.type, vendor:r.vendor, amount:r.amount, receipt_id:r.receipt_id })) : (j.spend||[]);
        const POL = Array.isArray(pol2) && pol2.length ? pol2.map(r=>({ key:r.key, active:r.active, checksum:r.checksum })) : (j.policies||[]);

        // Data fill
        put('glBody', GL, r=>tr(r.id, r.entity_id, r.account, fmt(r.amount), r.date));
        put('bankBody', BANK, r=>tr(r.id, r.account_ref, fmt(r.amount), r.date));
        put('matchBody', MATCH, r=>tr(r.gl_entry_id, r.bank_txn_id, fmt(r.confidence), r.receipt_id? {href:'#', text:r.receipt_id}:''));
        // Reconciliation scatter (index vs confidence)
        try {
          const mx = Array.isArray(j.matches) ? j.matches : [];
          const W=300, H=140, pad=16;
          const scat=document.createElementNS('http://www.w3.org/2000/svg','svg'); scat.setAttribute('width', String(W)); scat.setAttribute('height', String(H)); scat.setAttribute('viewBox', `0 0 ${W} ${H}`);
          const n = Math.max(1, mx.length);
          mx.slice(0, 100).forEach((m, i) => {
            const conf = Number(m.confidence||0);
            const x = pad + (i/Math.max(1,n-1))*(W - pad*2);
            const y = H - pad - (conf)*(H - pad*2);
            const c = conf >= 0.9 ? '#2ecc71' : conf >= 0.7 ? '#f39c12' : '#e74c3c';
            const dot=document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('cx', String(x)); dot.setAttribute('cy', String(y)); dot.setAttribute('r', '3'); dot.setAttribute('fill', c);
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${m.gl_entry_id} ↔ ${m.bank_txn_id} conf=${conf.toFixed(2)}`; dot.appendChild(tl);
            scat.appendChild(dot);
          })
          const title=document.createElement('h3'); title.style.margin='8px 0 6px 0'; title.style.fontSize='14px'; title.style.color='var(--dc-muted)'; title.textContent='Reconciliation Scatter (confidence)';
          const holder=document.createElement('div'); holder.appendChild(title); holder.appendChild(scat);
          document.getElementById('panel-matches').appendChild(holder);
        } catch {}
        put('ctrlBody', CTRL, r=>tr(r.control_key, (r.window_start||'')+' → '+(r.window_end||''), Array.isArray(r.findings?.items)? r.findings.items.length:0, r.receipt_id? {href:'#', text:r.receipt_id}:''));
        put('fluxBody', FLUX, r=>tr(r.entity_id, r.account, r.period, JSON.stringify(r.drivers), r.receipt_id? {href:'#', text:r.receipt_id}:''));
        put('fcBody', FC, r=>tr(r.period, JSON.stringify(r.params), JSON.stringify(r.outputs), r.receipt_id? {href:'#', text:r.receipt_id}:''));
        put('excBody', EXC, r=>{ const chip = r.status==='open'? mkChip('open','warn') : mkChip('closed','ok'); return tr(r.id, r.type, chip, r.assignee||'', r.receipt_id? {href:'#', text:r.receipt_id}:'' ) });
        put('spendBody', SPEND, r=>{ const t=String(r.type||''); const isDup=t.toLowerCase().includes('dup'); const isSaas=t.toLowerCase().includes('saas'); const chip= mkChip(r.type, (isDup||isSaas)?'warn':'ok'); return tr(chip, r.vendor||'', fmt(r.amount), r.receipt_id? {href:'#', text:r.receipt_id}:'' ) });
        put('polBody', POL, r=>tr(r.key, String(r.active), (r.checksum||'').slice(0,10)+'...'));

        // Policy impact matrix (synthetic 3x3 grid)
        try {
          const W=220, H=220, pad=20, n=3; const cell=(Math.min(W,H)-pad*2)/n;
          const svgMX=document.createElementNS('http://www.w3.org/2000/svg','svg'); svgMX.setAttribute('width', String(W)); svgMX.setAttribute('height', String(H)); svgMX.setAttribute('viewBox', `0 0 ${W} ${H}`);
          for(let r=0;r<n;r++){
            for(let c=0;c<n;c++){
              const v = Math.random();
              const col = v>0.66? '#e74c3c' : v>0.33? '#f39c12' : '#2ecc71';
              const x = pad + c*cell; const y = pad + r*cell;
              const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x', String(x)); rect.setAttribute('y', String(y)); rect.setAttribute('width', String(cell-6)); rect.setAttribute('height', String(cell-6)); rect.setAttribute('fill', col);
              const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `impact=${v.toFixed(2)} severity=${r+1} freq=${c+1}`; rect.appendChild(tl);
              svgMX.appendChild(rect);
            }
          }
          const title=document.createElement('h3'); title.style.margin='8px 0 6px 0'; title.style.fontSize='14px'; title.style.color='var(--dc-muted)'; title.textContent='Policy Impact Matrix';
          const holder=document.createElement('div'); holder.style.marginTop='12px'; holder.appendChild(title); holder.appendChild(svgMX);
          document.getElementById('panel-policies').appendChild(holder);
        } catch {}

        // Spend visuals: Pareto and Treemap
        try {
          const spendArr = Array.isArray(j.spend) ? j.spend : [];
          const sums = {};
          spendArr.forEach(s => { const v = String(s.vendor||'Other'); const amt = Number(s.amount||0); sums[v] = (sums[v]||0)+amt; });
          const entries = Object.entries(sums).map(([vendor, total])=>({ vendor, total:Number(total) })).sort((a,b)=>b.total-a.total).slice(0,8);
          const totalAll = entries.reduce((acc, x)=>acc + x.total, 0) || 1;
          const panelSpend = document.getElementById('panel-spend');
          const wrap=document.createElement('div'); wrap.style.marginTop='12px'; wrap.style.display='grid'; wrap.style.gridTemplateColumns='repeat(2, minmax(220px,1fr))'; wrap.style.gap='12px'; panelSpend.appendChild(wrap);

          // Pareto bar
          const paretoW=300, paretoH=140, pad=28, bar=12, gap=8;
          const svgPareto=document.createElementNS('http://www.w3.org/2000/svg','svg'); svgPareto.setAttribute('width', String(paretoW)); svgPareto.setAttribute('height', String(paretoH)); svgPareto.setAttribute('viewBox', `0 0 ${paretoW} ${paretoH}`);
          let y=pad;
          entries.forEach(e=>{
            const w = Math.max(4, (e.total/totalAll)*(paretoW - pad*2));
            const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x', String(pad)); rect.setAttribute('y', String(y)); rect.setAttribute('width', String(w)); rect.setAttribute('height', String(bar)); rect.setAttribute('fill','#57a6ff');
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${e.vendor}: $${e.total.toFixed(2)}`; rect.appendChild(tl);
            const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x', String(pad)); label.setAttribute('y', String(y-4)); label.setAttribute('fill','#8b99b5'); label.setAttribute('font-size','10'); label.textContent = e.vendor;
            svgPareto.appendChild(label); svgPareto.appendChild(rect);
            y += bar + gap;
          })
          const h3a=document.createElement('h3'); h3a.style.margin='0 0 6px 0'; h3a.style.fontSize='14px'; h3a.style.color='var(--dc-muted)'; h3a.textContent='Spend Pareto (Top Vendors)';
          const c1=document.createElement('div'); c1.appendChild(h3a); c1.appendChild(svgPareto); wrap.appendChild(c1);

          // Simple treemap (row layout)
          const treeW=300, treeH=140, padT=8;
          const svgTree=document.createElementNS('http://www.w3.org/2000/svg','svg'); svgTree.setAttribute('width', String(treeW)); svgTree.setAttribute('height', String(treeH)); svgTree.setAttribute('viewBox', `0 0 ${treeW} ${treeH}`);
          let x=padT; const usableW=treeW - padT*2; const usableH=treeH - padT*2; const rowH=usableH;
          entries.forEach((e,i)=>{
            const w = Math.max(8, (e.total/totalAll)*usableW);
            const rect=document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('x', String(x)); rect.setAttribute('y', String(padT)); rect.setAttribute('width', String(w)); rect.setAttribute('height', String(rowH)); rect.setAttribute('fill', i%2===0 ? '#2ecc71' : '#57a6ff');
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${e.vendor}: $${e.total.toFixed(2)}`; rect.appendChild(tl);
            svgTree.appendChild(rect);
            const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x', String(x+4)); label.setAttribute('y', String(padT+12)); label.setAttribute('fill','#0b1321'); label.setAttribute('font-size','10'); label.textContent = e.vendor;
            svgTree.appendChild(label);
            x += w + 2;
          })
          const h3b=document.createElement('h3'); h3b.style.margin='0 0 6px 0'; h3b.style.fontSize='14px'; h3b.style.color='var(--dc-muted)'; h3b.textContent='Spend Treemap (Simple)';
          const c2=document.createElement('div'); c2.appendChild(h3b); c2.appendChild(svgTree); wrap.appendChild(c2);
        } catch {}

        // Audit summary
        const audit = j.kpi_audit || {}; const dq = j.kpi_dq || {};
        document.getElementById('auditContent').innerHTML = `
          <div class="chips">
            <span class="chip ok">Receipts: ${audit.receipts_total ?? '-'}</span>
            <span class="chip ${dq.gl_days_since===0 && dq.bank_days_since===0 ? 'ok':'warn'}">Freshness GL ${dq.gl_days_since ?? '-'}d / Bank ${dq.bank_days_since ?? '-'}d</span>
          </div>`;

        // Receipt activity heatmap (synthetic weekly grid)
        try {
          const weeks = 6, days = 7, cell = 14, pad = 8;
          const W = weeks*cell + pad*2, H = days*cell + pad*2;
          const svgHM = document.createElementNS('http://www.w3.org/2000/svg','svg'); svgHM.setAttribute('width', String(W)); svgHM.setAttribute('height', String(H)); svgHM.setAttribute('viewBox', `0 0 ${W} ${H}`);
          const vals = [];
          for (let d=0; d<days; d++){ for (let w=0; w<weeks; w++){ vals.push(Math.random()) } }
          const color = (v)=> `rgba(87,166,255, ${0.15 + v*0.6})`;
          let idx=0; for(let d=0; d<days; d++){
            for(let w=0; w<weeks; w++){
              const v = vals[idx++]; const x = pad + w*cell; const y = pad + d*cell;
              const r = document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x', String(x)); r.setAttribute('y', String(y)); r.setAttribute('width', String(cell-2)); r.setAttribute('height', String(cell-2)); r.setAttribute('fill', color(v));
              svgHM.appendChild(r);
            }
          }
          const title = document.createElement('h3'); title.style.margin='8px 0 6px 0'; title.style.fontSize='14px'; title.style.color='var(--dc-muted)'; title.textContent='Receipt Activity Heatmap';
          const wrap = document.createElement('div'); wrap.style.marginTop='8px'; wrap.appendChild(title); wrap.appendChild(svgHM);
          document.getElementById('auditContent').appendChild(wrap);
        } catch {}

        // Controls run timeline
        try {
          const ctrl = Array.isArray(j.controls) ? j.controls : [];
          const W = 320, H = 60, pad=16;
          const svgTL = document.createElementNS('http://www.w3.org/2000/svg','svg'); svgTL.setAttribute('width', String(W)); svgTL.setAttribute('height', String(H)); svgTL.setAttribute('viewBox', `0 0 ${W} ${H}`);
          const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1', String(pad)); line.setAttribute('x2', String(W-pad)); line.setAttribute('y1', String(H/2)); line.setAttribute('y2', String(H/2)); line.setAttribute('stroke', '#1a2a4a'); line.setAttribute('stroke-width', '2'); svgTL.appendChild(line);
          const n = Math.max(1, ctrl.length);
          ctrl.slice(0, 10).forEach((c,i)=>{
            const x = pad + (i/Math.max(1,n-1))*(W-pad*2);
            const dot=document.createElementNS('http://www.w3.org/2000/svg','circle'); dot.setAttribute('cx', String(x)); dot.setAttribute('cy', String(H/2)); dot.setAttribute('r','4'); dot.setAttribute('fill','#57a6ff');
            const tl=document.createElementNS('http://www.w3.org/2000/svg','title'); tl.textContent = `${c.control_key} • findings=${Array.isArray(c?.findings?.items)?c.findings.items.length:0}`; dot.appendChild(tl);
            svgTL.appendChild(dot);
          })
          const h3=document.createElement('h3'); h3.style.margin='8px 0 6px 0'; h3.style.fontSize='14px'; h3.style.color='var(--dc-muted)'; h3.textContent='Controls Run Timeline';
          const holder = document.createElement('div'); holder.style.marginTop='12px'; holder.appendChild(h3); holder.appendChild(svgTL);
          document.getElementById('panel-controls').appendChild(holder);
        } catch {}
      }
      load().then(()=>{ route(); });
      window.addEventListener('hashchange', route);
    </script>
  </body>
  </html>


